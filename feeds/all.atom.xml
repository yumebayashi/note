<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>yumebayashi's note</title><link href="http://yumebayashi.github.io/note/" rel="alternate"></link><link href="http://yumebayashi.github.io/note/feeds/all.atom.xml" rel="self"></link><id>http://yumebayashi.github.io/note/</id><updated>2016-05-11T00:00:00+09:00</updated><entry><title>Calculate approximate distance between two latitude/longitude points by simple query</title><link href="http://yumebayashi.github.io/note/2016-05-11-latitude-longitude.html" rel="alternate"></link><published>2016-05-11T00:00:00+09:00</published><author><name>yumebayashi</name></author><id>tag:yumebayashi.github.io,2016-05-11:note/2016-05-11-latitude-longitude.html</id><summary type="html">&lt;ul&gt;
&lt;li&gt;make initial data set&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CREATE TABLE tmp_test (
   name character varying(255),
   lat1 numeric(8,5),
   lng1 numeric(8,5),
   lat2 numeric(8,5),
   lng2 numeric(8,5)
)
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;INSERT INTO tmp_test VALUES
(&amp;#39;tokyo-shinjuku&amp;#39;,35.680605, 139.767351,35.689862,139.700253);
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;select * from tmp_test ;
      name      |   lat1   |   lng1    |   lat2   |   lng2
----------------+----------+-----------+----------+-----------
 tokyo-shinjuku | 35.68061 | 139.76735 | 35.68986 | 139.70025
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;plan&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;consider the Earth as sphere&lt;/li&gt;
&lt;li&gt;calculate m/degree for each lat/lng&lt;/li&gt;
&lt;li&gt;calculate the distance of each directions&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;calculate the distance by Pythagorean theorem&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://en.wikipedia.org/wiki/Earth_radius"&gt;Earth radius&lt;/a&gt;&lt;br /&gt;
R : 6,371km = 6371000m  &lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Calculating the distance of latitude direction is simple.
&lt;/p&gt;
&lt;div class="math"&gt;$$ \frac{2\pi R}{360} abs(lat1 - lat2)  $$&lt;/div&gt;
&lt;p&gt;Calculating the distance of longitude direction is a bit complicated.&lt;br /&gt;
Radius varies by its latitude.&lt;br /&gt;
&lt;img src="/note/images/explain.png" width="300px"&gt;&lt;br /&gt;
I fix the radius by the middle point of two latitudes.&lt;/p&gt;
&lt;div class="math"&gt;$$ \frac{2\pi}{360} Rcos(\frac{\frac{(lat1 + lat2)}{2}\pi}{180}) abs(lng1 -lng2) $$&lt;/div&gt;
&lt;p&gt;then apply Pythagorean theorem
&lt;/p&gt;
&lt;div class="math"&gt;$$  \sqrt{(\frac{2\pi R}{360} (lat1 - lat2))^2 + (\frac{2\pi}{360} Rcos(\frac{\frac{(lat1 + lat2)}{2}\pi}{180}) (lng1 -lng2))^2} $$&lt;/div&gt;
&lt;p&gt;
â†“
&lt;/p&gt;
&lt;div class="math"&gt;$$ \frac{2\pi R}{360} \sqrt{(lat1 - lat2)^2 +  (cos(\frac{\frac{(lat1 + lat2)}{2}\pi}{180}) (lng1 -lng2))^2} $$&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;select *, 2 * pi() * 6371000 / 360 * sqrt(power((lat1-lat2),2) + power(cos((lat1 + lat2) / 2 * pi() /180) * (lng1-lng2),2)) as distance from tmp_test;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;      name      |   lat1   |   lng1    |   lat2   |   lng2    |     distance
----------------+----------+-----------+----------+-----------+------------------
 tokyo-shinjuku | 35.68061 | 139.76735 | 35.68986 | 139.70025 | 6146.88718108597
&lt;/pre&gt;&lt;/div&gt;


&lt;script type="text/javascript"&gt;if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width &lt; 768) ? "left" : align;
        indent = (screen.width &lt; 768) ? "0em" : indent;
        linebreak = (screen.width &lt; 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' &amp;&amp; location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
&lt;/script&gt;</summary><category term="sql"></category></entry><entry><title>Query Cheet Sheet in RedShift(Postgres)</title><link href="http://yumebayashi.github.io/note/2016-05-10-query-cheet-sheet.html" rel="alternate"></link><published>2016-05-10T00:00:00+09:00</published><author><name>yumebayashi</name></author><id>tag:yumebayashi.github.io,2016-05-10:note/2016-05-10-query-cheet-sheet.html</id><summary type="html">&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CREATE TABLE tmp_test (
   name character varying(255),
   value1 numeric(8,5),
   value2 numeric(8,5),
   created_at timestamp
)
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;bulk insert &amp;amp; create table&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;INSERT INTO tmp_test (name,value1,value2,created_at) VALUES
(&amp;#39;a&amp;#39;,11.111, 111.11, getdate()),
(&amp;#39;b&amp;#39;,22.222, 222.22, getdate() + interval &amp;#39;1 day&amp;#39;),
(&amp;#39;c&amp;#39;,33.333, 333.33, getdate() + interval &amp;#39;1 day 12 hour&amp;#39;),
(&amp;#39;d&amp;#39;,44.444, 444.44, getdate() - interval &amp;#39;1 year&amp;#39;);
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;you can omit &lt;code&gt;(name,value1,value2,created_at)&lt;/code&gt;
if the number of column you insert and the table has are same and know the order of the columns in the table.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SELECT * FROM tmp_test ORDER BY name;
 name |  value1  |  value2   |     created_at
------+----------+-----------+---------------------
 a    | 11.11100 | 111.11000 | 2016-04-09 01:41:46
 b    | 22.22200 | 222.22000 | 2016-04-10 01:41:46
 c    | 33.33300 | 333.33000 | 2016-04-10 13:41:46
 d    | 44.44400 | 444.44000 | 2015-04-09 01:41:46
&lt;/pre&gt;&lt;/div&gt;


&lt;hr /&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;INSERT INTO tmp_test2 (name) SELECT name FROM tmp_test
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SELECT * FROM tmp_test2;
 name | value1 | value2 | created_at
------+--------+--------+------------
 a    |        |        |
 b    |        |        |
 c    |        |        |
 d    |        |        |
&lt;/pre&gt;&lt;/div&gt;


&lt;hr /&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CREATE TABLE tmp_test3 AS SELECT name,value1 FROM tmp_test;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SELECT * FROM tmp_test3 ORDER BY name;
 name |  value1
------+----------
 a    | 11.11100
 b    | 22.22200
 c    | 33.33300
 d    | 44.44400
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;window function&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;make initial data set&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;INSERT INTO tmp_test (name,value1,value2,created_at) VALUES
(&amp;#39;a&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;a&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;a&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;a&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;b&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;b&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;b&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;b&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;c&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;c&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;c&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;c&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;d&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;d&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;d&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000)),
(&amp;#39;d&amp;#39;,random() * 100, random() * 1000, getdate() - (interval &amp;#39;1 second&amp;#39;) * floor(random() * 10000));
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SELECT * FROM tmp_test ORDER BY name,created_at;
 name |  value1  |  value2   |     created_at
------+----------+-----------+---------------------
 a    |  2.79153 | 283.88840 | 2016-05-09 02:48:03
 a    | 97.73130 | 690.71222 | 2016-05-09 04:04:00
 a    | 55.56720 | 648.48164 | 2016-05-09 04:07:29
 a    | 65.30828 |  82.12131 | 2016-05-09 04:54:15
 b    | 91.00008 | 520.90237 | 2016-05-09 03:00:32
 b    | 52.57934 | 994.37051 | 2016-05-09 04:10:30
 b    | 94.97609 | 991.10283 | 2016-05-09 04:23:42
 b    | 80.45081 | 281.75994 | 2016-05-09 04:40:12
 c    | 76.16128 | 781.77351 | 2016-05-09 02:59:04
 c    | 27.75059 | 738.44508 | 2016-05-09 03:57:41
 c    | 35.67327 | 322.03239 | 2016-05-09 04:08:57
 c    | 94.81574 | 294.11711 | 2016-05-09 04:56:16
 d    | 79.91998 | 862.42894 | 2016-05-09 03:20:00
 d    | 60.94562 | 388.22237 | 2016-05-09 03:20:56
 d    | 67.12917 | 952.42817 | 2016-05-09 04:46:49
 d    | 24.18907 | 299.34541 | 2016-05-09 05:00:30
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;add flag by the difference between value1 and value2&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SELECT *,
       (CASE
            WHEN diff &amp;gt; 500 THEN 1
            WHEN diff &amp;gt; 300 THEN 2
            WHEN diff &amp;gt; 100 THEN 3
            ELSE 0
        END) AS type
FROM
  (SELECT *, abs(value1 - value2) AS diff
   FROM tmp_test
   ORDER BY name,created_at)
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; name |  value1  |  value2   |     created_at      |   diff    | type
------+----------+-----------+---------------------+-----------+------
 a    |  2.79153 | 283.88840 | 2016-05-09 02:48:03 | 281.09687 |    3
 a    | 97.73130 | 690.71222 | 2016-05-09 04:04:00 | 592.98092 |    1
 a    | 55.56720 | 648.48164 | 2016-05-09 04:07:29 | 592.91444 |    1
 a    | 65.30828 |  82.12131 | 2016-05-09 04:54:15 |  16.81303 |    0
 b    | 91.00008 | 520.90237 | 2016-05-09 03:00:32 | 429.90229 |    2
 b    | 52.57934 | 994.37051 | 2016-05-09 04:10:30 | 941.79117 |    1
 b    | 94.97609 | 991.10283 | 2016-05-09 04:23:42 | 896.12674 |    1
 b    | 80.45081 | 281.75994 | 2016-05-09 04:40:12 | 201.30913 |    3
 c    | 76.16128 | 781.77351 | 2016-05-09 02:59:04 | 705.61223 |    1
 c    | 27.75059 | 738.44508 | 2016-05-09 03:57:41 | 710.69449 |    1
 c    | 35.67327 | 322.03239 | 2016-05-09 04:08:57 | 286.35912 |    3
 c    | 94.81574 | 294.11711 | 2016-05-09 04:56:16 | 199.30137 |    3
 d    | 79.91998 | 862.42894 | 2016-05-09 03:20:00 | 782.50896 |    1
 d    | 60.94562 | 388.22237 | 2016-05-09 03:20:56 | 327.27675 |    2
 d    | 67.12917 | 952.42817 | 2016-05-09 04:46:49 | 885.29900 |    1
 d    | 24.18907 | 299.34541 | 2016-05-09 05:00:30 | 275.15634 |    3
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;add sequential row number order by created_at for each name&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SELECT * ,
       row_number() over(PARTITION BY name ORDER BY created_at ASC)
FROM tmp_test
ORDER BY name,created_at ASC;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; name |  value1  |  value2   |     created_at      | row_number
------+----------+-----------+---------------------+------------
 a    |  2.79153 | 283.88840 | 2016-05-09 02:48:03 |          1
 a    | 97.73130 | 690.71222 | 2016-05-09 04:04:00 |          2
 a    | 55.56720 | 648.48164 | 2016-05-09 04:07:29 |          3
 a    | 65.30828 |  82.12131 | 2016-05-09 04:54:15 |          4
 b    | 91.00008 | 520.90237 | 2016-05-09 03:00:32 |          1
 b    | 52.57934 | 994.37051 | 2016-05-09 04:10:30 |          2
 b    | 94.97609 | 991.10283 | 2016-05-09 04:23:42 |          3
 b    | 80.45081 | 281.75994 | 2016-05-09 04:40:12 |          4
 c    | 76.16128 | 781.77351 | 2016-05-09 02:59:04 |          1
 c    | 27.75059 | 738.44508 | 2016-05-09 03:57:41 |          2
 c    | 35.67327 | 322.03239 | 2016-05-09 04:08:57 |          3
 c    | 94.81574 | 294.11711 | 2016-05-09 04:56:16 |          4
 d    | 79.91998 | 862.42894 | 2016-05-09 03:20:00 |          1
 d    | 60.94562 | 388.22237 | 2016-05-09 03:20:56 |          2
 d    | 67.12917 | 952.42817 | 2016-05-09 04:46:49 |          3
 d    | 24.18907 | 299.34541 | 2016-05-09 05:00:30 |          4
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;get value from a previous row in the table. To get a value from the next row, using the LEAD function. below two queries return the same result.(order in over function is inversed)&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; SELECT * , LAG(created_at, 1) OVER(PARTITION BY name ORDER BY created_at DESC) FROM tmp_test;

 SELECT * , LEAD(created_at, 1) OVER(PARTITION BY name ORDER BY created_at ASC) FROM tmp_test;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; name |  value1  |  value2   |     created_at      |         lag
------+----------+-----------+---------------------+---------------------
 a    |  2.79153 | 283.88840 | 2016-05-09 02:48:03 | 2016-05-09 04:04:00
 a    | 97.73130 | 690.71222 | 2016-05-09 04:04:00 | 2016-05-09 04:07:29
 a    | 55.56720 | 648.48164 | 2016-05-09 04:07:29 | 2016-05-09 04:54:15
 a    | 65.30828 |  82.12131 | 2016-05-09 04:54:15 |
 b    | 91.00008 | 520.90237 | 2016-05-09 03:00:32 | 2016-05-09 04:10:30
 b    | 52.57934 | 994.37051 | 2016-05-09 04:10:30 | 2016-05-09 04:23:42
 b    | 94.97609 | 991.10283 | 2016-05-09 04:23:42 | 2016-05-09 04:40:12
 b    | 80.45081 | 281.75994 | 2016-05-09 04:40:12 |
 c    | 76.16128 | 781.77351 | 2016-05-09 02:59:04 | 2016-05-09 03:57:41
 c    | 27.75059 | 738.44508 | 2016-05-09 03:57:41 | 2016-05-09 04:08:57
 c    | 35.67327 | 322.03239 | 2016-05-09 04:08:57 | 2016-05-09 04:56:16
 c    | 94.81574 | 294.11711 | 2016-05-09 04:56:16 |
 d    | 79.91998 | 862.42894 | 2016-05-09 03:20:00 | 2016-05-09 03:20:56
 d    | 60.94562 | 388.22237 | 2016-05-09 03:20:56 | 2016-05-09 04:46:49
 d    | 67.12917 | 952.42817 | 2016-05-09 04:46:49 | 2016-05-09 05:00:30
 d    | 24.18907 | 299.34541 | 2016-05-09 05:00:30 |
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;get the time difference(min) between current and previous row&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SELECT *,
       EXTRACT(EPOCH FROM next - created_at) / 60 AS stay_min
FROM
  (SELECT * ,
          LAG(created_at, 1) OVER(PARTITION BY name ORDER BY created_at DESC) AS next
   FROM tmp_test);


WITH t AS (
SELECT * , 
       LAG(created_at, 1) OVER(PARTITION BY name ORDER BY created_at DESC) AS next 
FROM tmp_test
) 
SELECT extract(epoch FROM next - created_at) / 60  AS stay_min FROM t;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt; name |  value1  |  value2   |     created_at      |        next         |     stay_min
------+----------+-----------+---------------------+---------------------+-------------------
 a    |  2.79153 | 283.88840 | 2016-05-09 02:48:03 | 2016-05-09 04:04:00 |             75.95
 a    | 97.73130 | 690.71222 | 2016-05-09 04:04:00 | 2016-05-09 04:07:29 |  3.48333333333333
 a    | 55.56720 | 648.48164 | 2016-05-09 04:07:29 | 2016-05-09 04:54:15 |  46.7666666666667
 a    | 65.30828 |  82.12131 | 2016-05-09 04:54:15 |                     |
 b    | 91.00008 | 520.90237 | 2016-05-09 03:00:32 | 2016-05-09 04:10:30 |  69.9666666666667
 b    | 52.57934 | 994.37051 | 2016-05-09 04:10:30 | 2016-05-09 04:23:42 |              13.2
 b    | 94.97609 | 991.10283 | 2016-05-09 04:23:42 | 2016-05-09 04:40:12 |              16.5
 b    | 80.45081 | 281.75994 | 2016-05-09 04:40:12 |                     |
 c    | 76.16128 | 781.77351 | 2016-05-09 02:59:04 | 2016-05-09 03:57:41 |  58.6166666666667
 c    | 27.75059 | 738.44508 | 2016-05-09 03:57:41 | 2016-05-09 04:08:57 |  11.2666666666667
 c    | 35.67327 | 322.03239 | 2016-05-09 04:08:57 | 2016-05-09 04:56:16 |  47.3166666666667
 c    | 94.81574 | 294.11711 | 2016-05-09 04:56:16 |                     |
 d    | 79.91998 | 862.42894 | 2016-05-09 03:20:00 | 2016-05-09 03:20:56 | 0.933333333333333
 d    | 60.94562 | 388.22237 | 2016-05-09 03:20:56 | 2016-05-09 04:46:49 |  85.8833333333333
 d    | 67.12917 | 952.42817 | 2016-05-09 04:46:49 | 2016-05-09 05:00:30 |  13.6833333333333
 d    | 24.18907 | 299.34541 | 2016-05-09 05:00:30 |                     |
&lt;/pre&gt;&lt;/div&gt;</summary><category term="sql"></category><category term="postgres"></category><category term="redshift"></category></entry><entry><title>RedShift Query Tips</title><link href="http://yumebayashi.github.io/note/2016-05-09-redshift-query-tips.html" rel="alternate"></link><published>2016-05-09T00:00:00+09:00</published><author><name>yumebayashi</name></author><id>tag:yumebayashi.github.io,2016-05-09:note/2016-05-09-redshift-query-tips.html</id><summary type="html">&lt;ul&gt;
&lt;li&gt;Confirm table definition&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;select * from pg_table_def where tablename = &amp;#39;target_table&amp;#39;;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;Check running query and its pid&lt;ul&gt;
&lt;li&gt;terminate query -&amp;gt; &lt;code&gt;cancel {pid}&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;select pid,starttime, left(query,50) from stv_recents where status=&amp;#39;Running&amp;#39;;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;Check whether the table needs to be vacuumed or not&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="cm"&gt;/** 0.not vacuumed table */&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kr"&gt;select&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0_not_sorted&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;status&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;tablename&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;sorted_rows&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;rows&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;cast&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;decimal&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;))&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;sort_percentage&lt;span class="w"&gt;&lt;/span&gt;
from&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kr"&gt;select&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;trim&lt;span class="o"&gt;(&lt;/span&gt;name&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;tablename&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum&lt;span class="o"&gt;(&lt;/span&gt;sorted_rows&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;sorted_rows&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum&lt;span class="o"&gt;(&lt;/span&gt;rows&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;rows&lt;span class="w"&gt;&lt;/span&gt;
from&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;stv_tbl_perm&lt;span class="w"&gt;&lt;/span&gt;
group&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kr"&gt;by&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;name&lt;span class="w"&gt;&lt;/span&gt;
order&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kr"&gt;by&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;name&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sum_result&lt;span class="w"&gt;&lt;/span&gt;
where&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sorted_rows&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
UNION&lt;span class="w"&gt; &lt;/span&gt;ALL&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="cm"&gt;/** 1.vacuumed table */&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="kr"&gt;select&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s"&gt;&amp;#39;1_sorted&amp;#39;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;status&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;tablename&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;sorted_rows&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;rows&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;cast&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;cast&lt;span class="o"&gt;(&lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;sorted_rows&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;double&lt;span class="w"&gt; &lt;/span&gt;precision&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;cast&lt;span class="o"&gt;(&lt;/span&gt;sum_result&lt;span class="o"&gt;.&lt;/span&gt;rows&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;double&lt;span class="w"&gt; &lt;/span&gt;precision&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;decimal&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;5&lt;/span&gt;&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;sort_percentage&lt;span class="w"&gt;&lt;/span&gt;
from&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="kr"&gt;select&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;trim&lt;span class="o"&gt;(&lt;/span&gt;name&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;tablename&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum&lt;span class="o"&gt;(&lt;/span&gt;sorted_rows&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;sorted_rows&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sum&lt;span class="o"&gt;(&lt;/span&gt;rows&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;as&lt;span class="w"&gt; &lt;/span&gt;rows&lt;span class="w"&gt;&lt;/span&gt;
from&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;stv_tbl_perm&lt;span class="w"&gt;&lt;/span&gt;
group&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kr"&gt;by&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;name&lt;span class="w"&gt;&lt;/span&gt;
order&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kr"&gt;by&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;name&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sum_result&lt;span class="w"&gt;&lt;/span&gt;
where&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sorted_rows&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;!&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
order&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kr"&gt;by&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;status&lt;span class="w"&gt; &lt;/span&gt;asc&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;sort_percentage&lt;span class="w"&gt; &lt;/span&gt;asc&lt;span class="o"&gt;,&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;rows&lt;span class="w"&gt; &lt;/span&gt;desc&lt;span class="err"&gt;;&lt;/span&gt;&lt;span class="w"&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;returns like below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    status    |             tablename              | sorted_rows |    rows     | sort_percentage
--------------+------------------------------------+-------------+-------------+-----------------
 0_not_sorted | hogehoge_table_0                   |           0 |    40980633 |           0.000
 0_not_sorted | hogehoge_table_1                   |           0 |      108008 |           0.000
 0_not_sorted | hogehoge_table_2                   |           0 |        5002 |           0.000
 0_not_sorted | hogehoge_table_3                   |           0 |        4000 |           0.000
 0_not_sorted | hogehoge_table_4                   |           0 |        1480 |           0.000
 1_sorted     | hogehoge_table_5                   |        1586 |       17003 |           0.093
 1_sorted     | hogehoge_table_6                   |    21258371 |   170611094 |           0.125
 1_sorted     | hogehoge_table_7                   |           1 |           2 |           0.500
 1_sorted     | hogehoge_table_8                   |     2037917 |     3253190 |           0.626
&lt;/pre&gt;&lt;/div&gt;</summary><category term="redshift"></category></entry></feed>